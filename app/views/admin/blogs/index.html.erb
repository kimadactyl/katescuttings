<% provide :template, 'admin' %>

<article class="admin-index" data-controller="admin-table">
  <%= link_to "New post", new_admin_blog_path, class: 'admin-button' %>

  <%= turbo_frame_tag "blogs-table" do %>
  <div class="admin-toolbar">
    <%= form_with url: admin_blogs_path, method: :get, data: { turbo_frame: "blogs-table" }, class: "admin-search" do |f| %>
      <%= f.label :q, "Search posts", class: "sr-only" %>
      <%= f.search_field :q, value: params[:q], placeholder: "Search posts...", class: "admin-search__input", data: { action: "input->admin-table#search" }, "aria-label": "Search posts" %>
      <% if params[:q].present? %>
        <%= link_to "Clear", admin_blogs_path(status: params[:status]), class: "admin-search__clear", data: { turbo_frame: "blogs-table" } %>
      <% end %>
    <% end %>

    <div class="admin-filters">
      <%= link_to "All", admin_blogs_path(q: params[:q]),
          class: "admin-filter #{params[:status].blank? ? 'admin-filter--active' : ''}",
          data: { turbo_frame: "blogs-table" } %>
      <%= link_to "Published", admin_blogs_path(status: "published", q: params[:q]),
          class: "admin-filter #{params[:status] == 'published' ? 'admin-filter--active' : ''}",
          data: { turbo_frame: "blogs-table" } %>
      <%= link_to "Scheduled", admin_blogs_path(status: "scheduled", q: params[:q]),
          class: "admin-filter #{params[:status] == 'scheduled' ? 'admin-filter--active' : ''}",
          data: { turbo_frame: "blogs-table" } %>
    </div>
  </div>

  <% if @blogs.any? %>
    <table class="admin-table" cellspacing="0">
      <thead>
        <tr>
          <th class="admin-table__th--title"><%= sortable "title" %></th>
          <th>Images</th>
          <th><%= sortable "created_at", "Created" %></th>
          <th><%= sortable "published_at", "Published" %></th>
          <th>Actions</th>
        </tr>
      </thead>
      <tbody>
        <% @blogs.each do |blog| %>
          <tr>
            <td><%= link_to blog.title, edit_admin_blog_path(blog), data: { turbo_frame: "_top" } %> <%= blog_status_badge(blog) %></td>
            <td class="admin-table__images" data-controller="lightbox">
              <% if blog.attachments.any? %>
                <% blog.attachments.each do |attachment| %>
                  <%= link_to attachment.image.variant(resize_to_limit: [2048, 2048], watermark: true),
                      class: "admin-thumb",
                      data: { lightbox_target: "item", caption: attachment.title } do %>
                    <%= image_tag attachment.image.variant(resize_to_fill: [40, 40]), alt: attachment.alt_text %>
                  <% end %>
                <% end %>
              <% else %>
                <span class="admin-table__no-images">No images</span>
              <% end %>
            </td>
            <td><%= relative_date(blog.created_at) %></td>
            <td><%= relative_date(blog.published_at) %></td>
            <td class="admin-table__actions">
              <%= link_to blog_path(blog), target: "_blank", title: "View post", "aria-label": "View post: #{blog.title}" do %>
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" aria-hidden="true"><path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"/><circle cx="12" cy="12" r="3"/></svg>
              <% end %>
              <%= link_to edit_admin_blog_path(blog), title: "Edit post", "aria-label": "Edit post: #{blog.title}", data: { turbo_frame: "_top" } do %>
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" aria-hidden="true"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"/><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"/></svg>
              <% end %>
              <%= button_to admin_blog_path(blog),
                            method: :delete,
                            form: { data: { turbo_confirm: 'Are you sure you want to delete this post?' } },
                            title: "Delete post",
                            "aria-label": "Delete post: #{blog.title}",
                            class: "admin-table__delete" do %>
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" aria-hidden="true"><path d="M3 6h18"/><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/></svg>
              <% end %>
            </td>
          </tr>
        <% end %>
      </tbody>
    </table>

    <%= paginate @blogs %>
  <% else %>
    <p class="admin-empty">No posts found<%= " matching \"#{params[:q]}\"" if params[:q].present? %>.</p>
  <% end %>
  <% end %>
</article>
